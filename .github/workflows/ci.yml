name: ROS 2 CI/CD Pipeline

# ğŸš€ 1. ì´ë²¤íŠ¸ íŠ¸ë¦¬ê±° ì„¤ì •: main ë¸Œëœì¹˜ì— ì½”ë“œê°€ í‘¸ì‹œë˜ê±°ë‚˜ Pull Requestê°€ ì—´ë¦´ ë•Œ ì‹¤í–‰
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

# ğŸ”‘ 2. í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
env:
  # ROS 2 ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ê²½ë¡œ
  ROS_WS: /ros2_ws
  # ìƒì„±í•  Docker ì´ë¯¸ì§€ ì´ë¦„
  IMAGE_NAME: ${{ github.repository }} # ì˜ˆ: 'your-username/my_ros2_robot_ci'
  # GitHub Container Registry (GHCR) ì£¼ì†Œ
  REGISTRY: ghcr.io

# ğŸ‘· 3. ì‘ì—…(Jobs) ì •ì˜
jobs:
  # ğŸ—ï¸ ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸ ì‘ì—… ì •ì˜
  build_and_test:
    # ì‹¤í–‰ í™˜ê²½: Ubuntu ìµœì‹  ë²„ì „ (x86 ì•„í‚¤í…ì²˜)
    runs-on: ubuntu-latest
    
    # ì‘ì—… ë‹¨ê³„ (Steps)
    steps:
      # â¬‡ï¸ ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # ì„œë¸Œëª¨ë“ˆ(Submodules)ì´ ìˆë‹¤ë©´ í•¨ê»˜ ì²´í¬ì•„ì›ƒí•©ë‹ˆë‹¤.
          submodules: recursive

      # ğŸ³ Docker ì´ë¯¸ì§€ ë¹Œë“œ
      - name: Build ROS 2 Docker image
        # Dockerfileì„ ì‚¬ìš©í•˜ì—¬ ROS 2 í™˜ê²½ì„ í¬í•¨í•œ ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•©ë‹ˆë‹¤.
        run: |
          docker build \
            -t ${{ env.IMAGE_NAME }}:latest \
            -f docker/Dockerfile \
            .

      # ğŸ§ª ROS 2 ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸ (Docker ë‚´ë¶€ì—ì„œ ì‹¤í–‰)
      - name: Build and Test ROS 2 package (colcon)
        # ë¹Œë“œëœ Docker ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•˜ì—¬ ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰í•˜ê³ , ê·¸ ì•ˆì—ì„œ ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:${{ env.ROS_WS }}/src/${{ github.event.repository.name }} \
            ${{ env.IMAGE_NAME }}:latest \
            /bin/bash -c " \
              source /opt/ros/humble/setup.bash && \
              cd ${{ env.ROS_WS }} && \
              # ROS 2 ì†ŒìŠ¤ ì½”ë“œë¥¼ ë³µì‚¬í•œ í›„ colcon ë¹Œë“œ ì‹¤í–‰
              colcon build --packages-select my_publisher && \
              # ê°„ë‹¨í•œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ì˜ˆ: colcon test ë˜ëŠ” unittest ì‹¤í–‰)
              echo '--- Simple Test Placeholder ---' && \
              echo 'Build successful. Image is ready.' \
            "

      # ğŸ“¦ (ì„ íƒ) GitHub Container Registryì— ë¡œê·¸ì¸
      - name: Login to GHCR
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          # GitHub Secretsì— ì €ì¥ëœ Personal Access Token(PAT) ì‚¬ìš©. 
          # íŒ¨í‚¤ì§€(Packages) ì“°ê¸° ê¶Œí•œì´ ìˆëŠ” í† í°ì´ì–´ì•¼ í•©ë‹ˆë‹¤.
          password: ${{ secrets.GITHUB_TOKEN }} 

      # ğŸ“¤ (ì„ íƒ) Docker ì´ë¯¸ì§€ íƒœê·¸ ë° GHCRì— í‘¸ì‹œ
      - name: Push Docker image to GHCR
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          # GHCR í‘œì¤€ íƒœê·¸ í˜•ì‹ (ghcr.io/username/repo-name:tag)
          IMAGE_TAG="${{ env.REGISTRY }}/${{ github.repository }}:latest"
          docker tag ${{ env.IMAGE_NAME }}:latest $IMAGE_TAG
          docker push $IMAGE_TAG
